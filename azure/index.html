<!DOCTYPE html>
<html>
<head>
    <title>GreenRoofing Sensor Monitor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);margin:0;padding:0;min-height:100vh}
        #main-container{max-width:1200px;margin:20px auto;background:rgba(255,255,255,0.95);padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.15);border-radius:20px;backdrop-filter:blur(10px)}
        h1{text-align:center;color:#2e7d32;margin-bottom:5px;font-size:2.5em;text-shadow:2px 2px 4px rgba(0,0,0,0.1)}
        .subtitle{text-align:center;color:#666;margin-bottom:20px;font-size:1.1em}
        h2{color:#2c3e50;border-bottom:3px solid #4caf50;padding-bottom:10px;margin-top:30px;font-size:1.6em}
        .readings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:25px}
        .reading-card{background:linear-gradient(145deg,#ffffff,#f0f0f0);padding:20px;border-radius:15px;text-align:center;border-left:6px solid #4caf50;box-shadow:0 8px 25px rgba(0,0,0,.1);transition:transform 0.3s ease}
        .reading-card:hover{transform:translateY(-3px)}
        .reading-card.rain{border-left-color:#2196f3;background:linear-gradient(145deg,#e3f2fd,#ffffff)}
        .reading-card.temp{border-left-color:#ff9800;background:linear-gradient(145deg,#fff3e0,#ffffff)}
        .reading-card.soil{border-left-color:#795548;background:linear-gradient(145deg,#efebe9,#ffffff)}
        .reading-card.moisture{border-left-color:#4caf50;background:linear-gradient(145deg,#e8f5e9,#ffffff)}
        .label{font-size:.95em;color:#555;margin-bottom:6px;font-weight:600}
        .value{font-size:2em;font-weight:700;margin:10px 0}
        .unit{font-size:0.4em;font-weight:normal;color:#888;margin-left:2px}
        .status{font-size:.75em;padding:3px 10px;border-radius:12px;display:inline-block;margin-top:5px}
        .status-ok{background:#c8e6c9;color:#2e7d32}
        .status-warn{background:#fff3cd;color:#856404}
        .status-error{background:#ffcdd2;color:#c62828}
        .status-info{background:#e3f2fd;color:#1565c0}
        .toggle-btn{font-size:.7em;padding:4px 10px;margin-top:8px;cursor:pointer;border:none;background:#4caf50;color:#fff;border-radius:15px}
        .toggle-btn:hover{background:#388e3c}
        .chart-container{background:linear-gradient(145deg,#ffffff,#f8f9fa);border:2px solid #e0e0e0;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
        .chart-title{margin:0 0 15px;font-size:1.2rem;color:#333;font-weight:600}
        .system-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px}
        .system-card{background:#f5f5f5;border-radius:10px;padding:15px}
        .system-card h3{margin:0 0 10px;font-size:.9rem;color:#333}
        .sensor-status{display:flex;align-items:center;margin:5px 0;font-size:.85em}
        .sensor-status .dot{width:10px;height:10px;border-radius:50%;margin-right:8px}
        .dot-green{background:#4caf50}
        .dot-red{background:#f44336}
        .footer{text-align:center;margin-top:25px;padding-top:15px;border-top:1px solid #eee;font-size:.85em;color:#888}
        .footer a{color:#4caf50}
        .cloud-badge{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:5px 15px;border-radius:20px;font-size:0.8em;display:inline-block;margin-bottom:10px}
        /* Tab styles */
        .tab-container{margin-bottom:25px}
        .tab-buttons{display:flex;gap:10px;flex-wrap:wrap;border-bottom:2px solid #e0e0e0;padding-bottom:0}
        .tab-btn{padding:12px 24px;border:none;background:transparent;color:#666;font-size:1em;cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;transition:all 0.3s ease;font-weight:500}
        .tab-btn:hover{color:#4caf50;background:rgba(76,175,80,0.05)}
        .tab-btn.active{color:#4caf50;border-bottom-color:#4caf50;background:rgba(76,175,80,0.1)}
        .tab-content{display:none;animation:fadeIn 0.3s ease}
        .tab-content.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        /* Analytics styles */
        .analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:25px}
        .stat-card{background:linear-gradient(145deg,#ffffff,#f8f9fa);border-radius:15px;padding:20px;border-left:5px solid #667eea;box-shadow:0 4px 15px rgba(0,0,0,.08)}
        .stat-card h4{margin:0 0 15px;color:#333;font-size:1rem;display:flex;align-items:center;gap:8px}
        .stat-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;font-size:.9em}
        .stat-row:last-child{border-bottom:none}
        .stat-label{color:#666}
        .stat-value{font-weight:600;color:#333}
        .trend-up{color:#4caf50}
        .trend-down{color:#f44336}
        .trend-stable{color:#9e9e9e}
        .insights-container{margin-bottom:25px}
        .insight-card{background:#fff;border-radius:12px;padding:15px 20px;margin-bottom:12px;display:flex;align-items:flex-start;gap:15px;box-shadow:0 2px 10px rgba(0,0,0,.05);border-left:4px solid #667eea}
        .insight-card.warning{border-left-color:#ff9800;background:linear-gradient(90deg,#fff8e1,#fff)}
        .insight-card.info{border-left-color:#2196f3;background:linear-gradient(90deg,#e3f2fd,#fff)}
        .insight-card.critical{border-left-color:#f44336;background:linear-gradient(90deg,#ffebee,#fff)}
        .insight-icon{font-size:1.5em}
        .insight-content h5{margin:0 0 5px;color:#333;font-size:.95rem}
        .insight-content p{margin:0;color:#666;font-size:.85rem}
        .anomaly-badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:.75em;font-weight:600;margin-left:8px}
        .anomaly-badge.warning{background:#fff3cd;color:#856404}
        .anomaly-badge.critical{background:#f8d7da;color:#721c24}
        .anomaly-badge.info{background:#d1ecf1;color:#0c5460}
        /* Advanced Analytics styles */
        .intel-card{background:linear-gradient(145deg,#fff,#f8f9fa);border-radius:15px;padding:25px;margin-bottom:20px;box-shadow:0 4px 20px rgba(0,0,0,.08);border-top:4px solid #667eea}
        .intel-card.watering{border-top-color:#2196f3}
        .intel-card.heat{border-top-color:#ff9800}
        .intel-card.growth{border-top-color:#4caf50}
        .intel-card h3{margin:0 0 15px;font-size:1.2rem;color:#333;display:flex;align-items:center;gap:10px}
        .intel-card h3 span{font-size:1.3em}
        .intel-metric{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #eee}
        .intel-metric:last-child{border-bottom:none}
        .intel-metric-label{color:#666;font-size:.9em}
        .intel-metric-value{font-weight:600;font-size:1.1em}
        .urgency-badge{padding:5px 12px;border-radius:20px;font-size:.8em;font-weight:600}
        .urgency-low{background:#c8e6c9;color:#2e7d32}
        .urgency-medium{background:#fff3cd;color:#856404}
        .urgency-high{background:#ffcc80;color:#e65100}
        .urgency-critical{background:#ffcdd2;color:#c62828}
        .status-badge{padding:5px 12px;border-radius:20px;font-size:.8em;font-weight:600}
        .status-normal{background:#c8e6c9;color:#2e7d32}
        .status-mild{background:#fff3cd;color:#856404}
        .status-moderate{background:#ffcc80;color:#e65100}
        .status-severe{background:#ffcdd2;color:#c62828}
        .status-cool_canopy{background:#e3f2fd;color:#1565c0}
        .progress-bar{height:10px;background:#e0e0e0;border-radius:5px;overflow:hidden;margin-top:8px}
        .progress-fill{height:100%;background:linear-gradient(90deg,#4caf50,#8bc34a);border-radius:5px;transition:width 0.5s ease}
        .recommendation-box{background:linear-gradient(135deg,#e3f2fd,#bbdefb);padding:15px;border-radius:10px;margin-top:15px;border-left:4px solid #2196f3}
        .recommendation-box p{margin:0;color:#1565c0;font-weight:500}
        .gdd-chart{margin-top:15px}
    </style>
</head>
<body>
<div id="main-container">
    <div style="text-align:center"><span class="cloud-badge">Azure Cloud Dashboard</span></div>
    <h1>GreenRoofing Sensor Monitor</h1>
    <p class="subtitle">Version 3.0 | Real-time soil and weather monitoring</p>

    <!-- Tab Navigation -->
    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab-btn" onclick="showTab('analytics')">Analytics & Intelligence</button>
        </div>
    </div>

    <!-- Dashboard Tab -->
    <div id="tab-dashboard" class="tab-content active">
        <h2>Live Sensor Readings</h2>
        <div class="readings-grid">
            <div class="reading-card soil">
                <div class="label">Soil Temperature</div>
                <div id="soil-temp-value" class="value" style="color:#795548" data-c="--" data-f="--">--.-<span class="unit">C</span></div>
                <div id="soil-temp-status" class="status status-ok">Loading...</div>
                <button id="soil-temp-toggle" class="toggle-btn">Show F</button>
            </div>
            <div class="reading-card moisture">
                <div class="label">Soil Moisture</div>
                <div id="soil-moisture-value" class="value" style="color:#4caf50">--<span class="unit">%</span></div>
                <div id="soil-moisture-status" class="status status-ok">Loading...</div>
            </div>
            <div class="reading-card temp">
                <div class="label">Leaf/Surface Temp</div>
                <div id="ir-temp-value" class="value" style="color:#ff9800" data-c="--" data-f="--">--.-<span class="unit">C</span></div>
                <div id="ir-temp-status" class="status status-ok">Loading...</div>
                <button id="ir-temp-toggle" class="toggle-btn">Show F</button>
            </div>
            <div class="reading-card rain">
                <div class="label">Rainfall (1 hour)</div>
                <div id="rainfall-value" class="value" style="color:#2196f3">--<span class="unit">mm</span></div>
                <div id="rainfall-status" class="status status-info">Loading...</div>
            </div>
        </div>

        <h2>Insights & Alerts</h2>
        <div id="insights-container" class="insights-container">
            <div class="insight-card info"><span class="insight-icon">...</span><div class="insight-content"><p>Loading insights...</p></div></div>
        </div>

        <h2>Statistical Summary</h2>
        <div class="analytics-grid">
            <div class="stat-card">
                <h4>Soil Temperature</h4>
                <div class="stat-row"><span class="stat-label">Average</span><span class="stat-value" id="soil-temp-avg">--</span></div>
                <div class="stat-row"><span class="stat-label">Min / Max</span><span class="stat-value" id="soil-temp-range">--</span></div>
                <div class="stat-row"><span class="stat-label">Trend</span><span class="stat-value" id="soil-temp-trend">--</span></div>
            </div>
            <div class="stat-card">
                <h4>Soil Moisture</h4>
                <div class="stat-row"><span class="stat-label">Average</span><span class="stat-value" id="moisture-avg">--</span></div>
                <div class="stat-row"><span class="stat-label">Min / Max</span><span class="stat-value" id="moisture-range">--</span></div>
                <div class="stat-row"><span class="stat-label">Trend</span><span class="stat-value" id="moisture-trend">--</span></div>
            </div>
            <div class="stat-card">
                <h4>IR Temperature</h4>
                <div class="stat-row"><span class="stat-label">Average</span><span class="stat-value" id="ir-temp-avg">--</span></div>
                <div class="stat-row"><span class="stat-label">Min / Max</span><span class="stat-value" id="ir-temp-range">--</span></div>
                <div class="stat-row"><span class="stat-label">Trend</span><span class="stat-value" id="ir-temp-trend">--</span></div>
            </div>
            <div class="stat-card">
                <h4>Rainfall</h4>
                <div class="stat-row"><span class="stat-label">Total</span><span class="stat-value" id="rain-total">--</span></div>
                <div class="stat-row"><span class="stat-label">Max Hourly</span><span class="stat-value" id="rain-max">--</span></div>
                <div class="stat-row"><span class="stat-label">Rainy Readings</span><span class="stat-value" id="rain-count">--</span></div>
            </div>
        </div>

        <h2>Real-time Charts</h2>
        <div class="chart-container">
            <div class="chart-title">Temperature & Moisture Trends</div>
            <div id="chart-soil"></div>
        </div>
        <div class="chart-container">
            <div class="chart-title">Precipitation Analysis</div>
            <div id="chart-rainfall"></div>
        </div>
        <div class="chart-container">
            <div class="chart-title">IR Temperature Monitoring</div>
            <div id="chart-ir"></div>
        </div>

        <h2>System Status</h2>
        <div class="system-grid">
            <div class="system-card">
                <h3>Data Source</h3>
                <div style="font-size:.85em;color:#555">
                    <div>Device ID: <b id="device-id">--</b></div>
                    <div>Readings: <b id="readings-count">--</b></div>
                    <div>Version: <b id="version">3.0</b></div>
                </div>
            </div>
            <div class="system-card">
                <h3>Sensor Status</h3>
                <div class="sensor-status"><div class="dot dot-green"></div>Rainfall Sensor</div>
                <div class="sensor-status"><div class="dot dot-green"></div>IR Temperature</div>
                <div class="sensor-status"><div class="dot dot-green"></div>Soil Temperature</div>
                <div class="sensor-status"><div class="dot dot-green"></div>Soil Moisture</div>
            </div>
        </div>
    </div>

    <!-- Analytics & Intelligence Tab -->
    <div id="tab-analytics" class="tab-content">
        <h2>Predictive Watering</h2>
        <div class="intel-card watering">
            <h3><span>üíß</span> Irrigation Intelligence</h3>
            <div class="intel-metric">
                <span class="intel-metric-label">Current Soil Moisture</span>
                <span class="intel-metric-value" id="pred-moisture">--%</span>
            </div>
            <div class="intel-metric">
                <span class="intel-metric-label">Moisture Depletion Rate</span>
                <span class="intel-metric-value" id="pred-rate">-- %/hr</span>
            </div>
            <div class="intel-metric">
                <span class="intel-metric-label">Time Until Critical (30%)</span>
                <span class="intel-metric-value" id="pred-hours">-- hours</span>
            </div>
            <div class="intel-metric">
                <span class="intel-metric-label">Watering Urgency</span>
                <span class="intel-metric-value"><span id="pred-urgency" class="urgency-badge urgency-low">--</span></span>
            </div>
            <div class="recommendation-box">
                <p id="pred-recommendation">Loading recommendation...</p>
            </div>
        </div>

        <h2>Heat Stress Analysis</h2>
        <div class="intel-card heat">
            <h3><span>üå°Ô∏è</span> Plant Stress Monitor</h3>
            <div class="intel-metric">
                <span class="intel-metric-label">Current Status</span>
                <span class="intel-metric-value"><span id="heat-status" class="status-badge status-normal">--</span></span>
            </div>
            <div class="intel-metric">
                <span class="intel-metric-label">Leaf Temperature</span>
                <span class="intel-metric-value" id="heat-leaf">--¬∞C</span>
            </div>
            <div class="intel-metric">
                <span class="intel-metric-label">Soil Temperature</span>
                <span class="intel-metric-value" id="heat-soil">--¬∞C</span>
            </div>
            <div class="intel-metric">
                <span class="intel-metric-label">Temperature Difference</span>
                <span class="intel-metric-value" id="heat-diff">--¬∞C</span>
            </div>
            <div class="intel-metric">
                <span class="intel-metric-label">Stress Events Detected</span>
                <span class="intel-metric-value" id="heat-events">--</span>
            </div>
        </div>

        <h2>Growing Degree Days (GDD)</h2>
        <div class="intel-card growth">
            <h3><span>üå±</span> Plant Growth Tracking</h3>
            <div class="intel-metric">
                <span class="intel-metric-label">Base Temperature</span>
                <span class="intel-metric-value" id="gdd-base">10¬∞C</span>
            </div>
            <div class="intel-metric">
                <span class="intel-metric-label">Accumulated GDD</span>
                <span class="intel-metric-value" id="gdd-total">--</span>
            </div>
            <div class="intel-metric">
                <span class="intel-metric-label">Growth Stage</span>
                <span class="intel-metric-value" id="gdd-stage">--</span>
            </div>
            <div class="intel-metric">
                <span class="intel-metric-label">Stage Description</span>
                <span class="intel-metric-value" id="gdd-desc" style="font-size:.9em;font-weight:400">--</span>
            </div>
            <div style="margin-top:15px">
                <div style="display:flex;justify-content:space-between;font-size:.85em;color:#666;margin-bottom:5px">
                    <span>Stage Progress</span>
                    <span id="gdd-progress-text">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="gdd-progress" style="width:0%"></div>
                </div>
            </div>
            <div class="gdd-chart">
                <div id="chart-gdd"></div>
            </div>
        </div>

        <h2>Hourly Trend Analysis</h2>
        <div class="chart-container">
            <div class="chart-title">Hourly Temperature Averages</div>
            <div id="chart-hourly-temp"></div>
        </div>
        <div class="chart-container">
            <div class="chart-title">Hourly Moisture Averages</div>
            <div id="chart-hourly-moisture"></div>
        </div>
    </div>

    <div class="footer">
        <p>Last Updated: <span id="last-updated">Never</span></p>
        <p>Data from Azure Table Storage | GreenRoofing Sensor Network</p>
    </div>
</div>

<script>
const API_BASE = 'https://green-roof-aghegcb4daavg7d0.centralus-01.azurewebsites.net';

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    event.target.classList.add('active');
}

document.addEventListener('DOMContentLoaded', function() {
    let soilTempCelsius = true, irTempCelsius = true;

    // Main charts
    const soilChart = new ApexCharts(document.querySelector("#chart-soil"), {
        series: [],
        chart: { height: 300, type: 'line', toolbar: { show: true }, zoom: { enabled: true } },
        stroke: { curve: 'smooth', width: [3, 3] },
        xaxis: { type: 'datetime', labels: { datetimeUTC: false, format: 'HH:mm' } },
        yaxis: [
            { title: { text: "Temp (¬∞C)" }, labels: { formatter: v => v.toFixed(1) } },
            { opposite: true, min: 0, max: 100, title: { text: "Moisture (%)" }, labels: { formatter: v => v.toFixed(0) } }
        ],
        colors: ['#795548', '#4caf50'],
        legend: { position: 'top' },
        tooltip: { shared: true, x: { format: 'MMM dd HH:mm' } },
        markers: { size: 3 }
    });
    soilChart.render();

    const rainChart = new ApexCharts(document.querySelector("#chart-rainfall"), {
        series: [],
        chart: { height: 250, type: 'bar', toolbar: { show: true } },
        plotOptions: { bar: { borderRadius: 4, columnWidth: '60%' } },
        xaxis: { type: 'datetime', labels: { datetimeUTC: false, format: 'HH:mm' } },
        yaxis: { title: { text: 'Rainfall (mm)' }, min: 0 },
        colors: ['#2196f3'],
        tooltip: { x: { format: 'MMM dd HH:mm' } }
    });
    rainChart.render();

    const irChart = new ApexCharts(document.querySelector("#chart-ir"), {
        series: [],
        chart: { height: 250, type: 'line', toolbar: { show: true }, zoom: { enabled: true } },
        stroke: { curve: 'smooth', width: 3 },
        xaxis: { type: 'datetime', labels: { datetimeUTC: false, format: 'HH:mm' } },
        yaxis: { title: { text: 'Temp (¬∞C)' }, labels: { formatter: v => v.toFixed(1) } },
        colors: ['#ff9800'],
        markers: { size: 3 },
        tooltip: { x: { format: 'MMM dd HH:mm' } }
    });
    irChart.render();

    // Analytics charts
    const gddChart = new ApexCharts(document.querySelector("#chart-gdd"), {
        series: [],
        chart: { height: 200, type: 'area', toolbar: { show: false }, sparkline: { enabled: false } },
        stroke: { curve: 'smooth', width: 2 },
        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1 } },
        xaxis: { type: 'category' },
        yaxis: { title: { text: 'GDD' } },
        colors: ['#4caf50'],
        dataLabels: { enabled: false }
    });
    gddChart.render();

    const hourlyTempChart = new ApexCharts(document.querySelector("#chart-hourly-temp"), {
        series: [],
        chart: { height: 280, type: 'line', toolbar: { show: true } },
        stroke: { curve: 'smooth', width: [3, 3] },
        xaxis: { type: 'category' },
        yaxis: { title: { text: 'Temperature (¬∞C)' } },
        colors: ['#795548', '#ff9800'],
        legend: { position: 'top' },
        markers: { size: 4 }
    });
    hourlyTempChart.render();

    const hourlyMoistureChart = new ApexCharts(document.querySelector("#chart-hourly-moisture"), {
        series: [],
        chart: { height: 280, type: 'area', toolbar: { show: true } },
        stroke: { curve: 'smooth', width: 2 },
        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.1 } },
        xaxis: { type: 'category' },
        yaxis: { title: { text: 'Moisture (%)' }, min: 0, max: 100 },
        colors: ['#4caf50'],
        dataLabels: { enabled: false }
    });
    hourlyMoistureChart.render();

    // Temperature toggles
    document.getElementById('soil-temp-toggle').addEventListener('click', function() {
        soilTempCelsius = !soilTempCelsius;
        updateSoilTempDisplay();
    });
    document.getElementById('ir-temp-toggle').addEventListener('click', function() {
        irTempCelsius = !irTempCelsius;
        updateIrTempDisplay();
    });

    function updateSoilTempDisplay() {
        const el = document.getElementById('soil-temp-value');
        el.innerHTML = soilTempCelsius ? el.getAttribute('data-c') + '<span class="unit">C</span>' : el.getAttribute('data-f') + '<span class="unit">F</span>';
        document.getElementById('soil-temp-toggle').innerText = soilTempCelsius ? 'Show F' : 'Show C';
    }
    function updateIrTempDisplay() {
        const el = document.getElementById('ir-temp-value');
        el.innerHTML = irTempCelsius ? el.getAttribute('data-c') + '<span class="unit">C</span>' : el.getAttribute('data-f') + '<span class="unit">F</span>';
        document.getElementById('ir-temp-toggle').innerText = irTempCelsius ? 'Show F' : 'Show C';
    }

    function updateLiveData() {
        fetch(API_BASE + '/api/sensor-data?limit=100').then(r => r.json()).then(d => {
            // Live readings
            const stEl = document.getElementById('soil-temp-value');
            stEl.setAttribute('data-c', d.live.soil_temp_c.toFixed(1));
            stEl.setAttribute('data-f', d.live.soil_temp_f.toFixed(1));
            updateSoilTempDisplay();
            document.getElementById('soil-temp-status').innerText = 'Active';

            document.getElementById('soil-moisture-value').innerHTML = d.live.soil_moisture.toFixed(0) + '<span class="unit">%</span>';
            document.getElementById('soil-moisture-status').innerText = d.live.soil_moisture < 30 ? 'Dry' : d.live.soil_moisture > 70 ? 'Wet' : 'Optimal';

            const irEl = document.getElementById('ir-temp-value');
            irEl.setAttribute('data-c', d.live.ir_object_temp_c.toFixed(1));
            irEl.setAttribute('data-f', d.live.ir_object_temp_f.toFixed(1));
            updateIrTempDisplay();
            document.getElementById('ir-temp-status').innerText = 'Active';

            document.getElementById('rainfall-value').innerHTML = d.live.rainfall_hourly.toFixed(1) + '<span class="unit">mm</span>';
            document.getElementById('rainfall-status').innerText = d.live.rainfall_hourly > 0 ? 'Raining' : 'None';

            document.getElementById('device-id').innerText = d.system.device_id || '--';
            document.getElementById('readings-count').innerText = d.readings_count || '--';
            document.getElementById('version').innerText = d.system.version || '3.0';

            // Charts
            if (d.history && d.history.datetimes) {
                const datetimes = d.history.datetimes.map(dt => new Date(dt + 'Z').getTime());
                soilChart.updateSeries([
                    { name: 'Soil Temp', data: datetimes.map((t, i) => [t, d.history.soil_temps[i] || 0]) },
                    { name: 'Moisture', data: datetimes.map((t, i) => [t, d.history.soil_moistures[i] || 0]) }
                ]);
                rainChart.updateSeries([{ name: 'Rainfall', data: datetimes.map((t, i) => [t, d.history.rainfall[i] || 0]) }]);
                irChart.updateSeries([{ name: 'IR Temp', data: datetimes.map((t, i) => [t, d.history.ir_temps[i] || 0]) }]);
            }

            // Basic analytics
            if (d.analytics) {
                const a = d.analytics;
                if (a.soil_temp) {
                    document.getElementById('soil-temp-avg').innerText = a.soil_temp.avg + '¬∞C';
                    document.getElementById('soil-temp-range').innerText = a.soil_temp.min + ' / ' + a.soil_temp.max + '¬∞C';
                    const trendEl = document.getElementById('soil-temp-trend');
                    trendEl.innerText = a.soil_temp.trend === 'rising' ? '‚Üë Rising' : a.soil_temp.trend === 'falling' ? '‚Üì Falling' : '‚Üí Stable';
                    trendEl.className = 'stat-value trend-' + (a.soil_temp.trend === 'rising' ? 'up' : a.soil_temp.trend === 'falling' ? 'down' : 'stable');
                }
                if (a.soil_moisture) {
                    document.getElementById('moisture-avg').innerText = a.soil_moisture.avg + '%';
                    document.getElementById('moisture-range').innerText = a.soil_moisture.min + ' / ' + a.soil_moisture.max + '%';
                    const trendEl = document.getElementById('moisture-trend');
                    trendEl.innerText = a.soil_moisture.trend === 'rising' ? '‚Üë Rising' : a.soil_moisture.trend === 'falling' ? '‚Üì Falling' : '‚Üí Stable';
                    trendEl.className = 'stat-value trend-' + (a.soil_moisture.trend === 'rising' ? 'up' : a.soil_moisture.trend === 'falling' ? 'down' : 'stable');
                }
                if (a.ir_temp) {
                    document.getElementById('ir-temp-avg').innerText = a.ir_temp.avg + '¬∞C';
                    document.getElementById('ir-temp-range').innerText = a.ir_temp.min + ' / ' + a.ir_temp.max + '¬∞C';
                    const trendEl = document.getElementById('ir-temp-trend');
                    trendEl.innerText = a.ir_temp.trend === 'rising' ? '‚Üë Rising' : a.ir_temp.trend === 'falling' ? '‚Üì Falling' : '‚Üí Stable';
                    trendEl.className = 'stat-value trend-' + (a.ir_temp.trend === 'rising' ? 'up' : a.ir_temp.trend === 'falling' ? 'down' : 'stable');
                }
                if (a.rainfall) {
                    document.getElementById('rain-total').innerText = a.rainfall.total + ' mm';
                    document.getElementById('rain-max').innerText = a.rainfall.max + ' mm';
                    document.getElementById('rain-count').innerText = a.rainfall.rainy_readings;
                }
            }

            // Insights
            const insightsContainer = document.getElementById('insights-container');
            let insightsHtml = '';
            if (d.anomalies && d.anomalies.length > 0) {
                d.anomalies.forEach(a => {
                    insightsHtml += `<div class="insight-card ${a.severity}"><span class="insight-icon">‚ö†Ô∏è</span><div class="insight-content"><h5>${a.sensor}<span class="anomaly-badge ${a.severity}">${a.severity}</span></h5><p>${a.message}</p></div></div>`;
                });
            }
            if (d.insights && d.insights.length > 0) {
                d.insights.forEach(i => {
                    insightsHtml += `<div class="insight-card ${i.type}"><span class="insight-icon">${i.icon}</span><div class="insight-content"><h5>${i.title}</h5><p>${i.message}</p></div></div>`;
                });
            }
            if (insightsHtml === '') {
                insightsHtml = '<div class="insight-card info"><span class="insight-icon">‚úì</span><div class="insight-content"><h5>All Systems Normal</h5><p>No anomalies detected. Sensor readings are within expected ranges.</p></div></div>';
            }
            insightsContainer.innerHTML = insightsHtml;

            // Advanced Analytics
            if (d.advanced_analytics) {
                const adv = d.advanced_analytics;

                // Predictive Watering
                if (adv.predictive_watering) {
                    const pw = adv.predictive_watering;
                    document.getElementById('pred-moisture').innerText = pw.current_moisture + '%';
                    document.getElementById('pred-rate').innerText = (pw.depletion_rate >= 0 ? '+' : '') + pw.depletion_rate.toFixed(2) + ' %/hr';
                    document.getElementById('pred-hours').innerText = pw.hours_until_critical ? pw.hours_until_critical + ' hours' : 'N/A';
                    const urgencyEl = document.getElementById('pred-urgency');
                    urgencyEl.innerText = pw.watering_urgency.charAt(0).toUpperCase() + pw.watering_urgency.slice(1);
                    urgencyEl.className = 'urgency-badge urgency-' + pw.watering_urgency;
                    document.getElementById('pred-recommendation').innerText = pw.recommendation;
                }

                // Heat Stress
                if (adv.heat_stress) {
                    const hs = adv.heat_stress;
                    const statusEl = document.getElementById('heat-status');
                    const statusText = hs.current_status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    statusEl.innerText = statusText;
                    statusEl.className = 'status-badge status-' + hs.current_status;
                    document.getElementById('heat-leaf').innerText = hs.current_leaf_temp + '¬∞C';
                    document.getElementById('heat-soil').innerText = hs.current_soil_temp + '¬∞C';
                    document.getElementById('heat-diff').innerText = (hs.current_difference >= 0 ? '+' : '') + hs.current_difference + '¬∞C';
                    document.getElementById('heat-events').innerText = hs.stress_events_count;
                }

                // GDD
                if (adv.growing_degree_days) {
                    const gdd = adv.growing_degree_days;
                    document.getElementById('gdd-base').innerText = gdd.base_temperature + '¬∞C';
                    document.getElementById('gdd-total').innerText = gdd.total_gdd;
                    if (gdd.growth_stage_estimate) {
                        document.getElementById('gdd-stage').innerText = gdd.growth_stage_estimate.stage;
                        document.getElementById('gdd-desc').innerText = gdd.growth_stage_estimate.description;
                        document.getElementById('gdd-progress').style.width = gdd.growth_stage_estimate.progress + '%';
                        document.getElementById('gdd-progress-text').innerText = gdd.growth_stage_estimate.progress + '%';
                    }
                    if (gdd.daily_gdd && gdd.daily_gdd.length > 0) {
                        gddChart.updateSeries([{
                            name: 'Cumulative GDD',
                            data: gdd.daily_gdd.map(d => ({ x: d.date, y: d.cumulative_gdd }))
                        }]);
                    }
                }

                // Hourly trends
                if (adv.trend_analysis) {
                    const ta = adv.trend_analysis;
                    if (ta.soil_temp_hourly && ta.soil_temp_hourly.length > 0) {
                        hourlyTempChart.updateSeries([
                            { name: 'Soil Temp', data: ta.soil_temp_hourly.map(h => ({ x: h.hour.slice(-5), y: h.avg })) },
                            { name: 'IR Temp', data: ta.ir_temp_hourly.map(h => ({ x: h.hour.slice(-5), y: h.avg })) }
                        ]);
                    }
                    if (ta.moisture_hourly && ta.moisture_hourly.length > 0) {
                        hourlyMoistureChart.updateSeries([{
                            name: 'Moisture',
                            data: ta.moisture_hourly.map(h => ({ x: h.hour.slice(-5), y: h.avg }))
                        }]);
                    }
                }
            }

            document.getElementById('last-updated').innerText = new Date().toLocaleTimeString();
        }).catch(err => {
            console.error("Data fetch failed:", err);
            document.getElementById('last-updated').innerText = 'Error: ' + err.message;
        });
    }

    updateLiveData();
    setInterval(updateLiveData, 30000);
});
</script>
</body>
</html>
